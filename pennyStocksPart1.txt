Sub pennyStocksPart1()
' Open Holdings and run Macro
' TLN original version

Dim wb_holdings As Workbook
Set wb_holdings = ActiveWorkbook

'filter price for less than $5
Range("R1").Select
Selection.AutoFilter
ActiveSheet.UsedRange.AutoFilter Field:=18, Criteria1:="<=5" _
    , Operator:=xlAnd

ActiveSheet.UsedRange.Copy

'copy data into new work book, close the holdings workbook
Set NewBook = Workbooks.Add


NewBook.Worksheets("Sheet1").Range("A1").PasteSpecial (xlPasteValues)

Dim ws_main As Worksheet
Set ws_main = ActiveSheet


'close the holdings workbook
Application.DisplayAlerts = False
wb_holdings.Close
Application.DisplayAlerts = True


'remove rows where stock price is less than or equal to 5

Dim LR As Long
Dim i As Integer

LR = Cells(Rows.Count, "A").End(xlUp).Row

For i = 2 To LR
    
    If Len(Cells(i, "B").value) >= 5 Then

        Rows(i).EntireRow.Delete
        i = i - 1
    
    End If


Next i


'remove duplicates
    Range("C:D,F:F,H:Q").Select
    Selection.Delete Shift:=xlToLeft
    Columns("A:A").Select
    ActiveSheet.UsedRange.RemoveDuplicates Columns:=Array(1, 2, 3), _
        Header:=xlYes
    Columns("E:E").Select
    Application.CutCopyMode = False
    Selection.Cut
    Columns("D:D").Select
    Selection.Insert Shift:=xlToRight


ActiveSheet.UsedRange.Copy
Sheets.Add After:=ActiveSheet
ActiveSheet.Paste
 
Dim ws_final  As Worksheet
Set ws_final = ActiveSheet


'fill the formulas for next part

Rows("1:1").Select
Selection.Delete Shift:=xlUp
Columns("A:A").Select
Selection.Delete Shift:=xlToLeft
Columns("B:D").Select
Selection.Delete Shift:=xlToLeft


Columns("A:A").Select
ActiveSheet.UsedRange.RemoveDuplicates Columns:=1, Header:=xlNo


Dim LastRow As Long

LastRow = Cells(Rows.Count, "A").End(xlUp).Row


Range("B1").Select
ActiveCell.FormulaR1C1 = "US Equity"


Range("A1").Select
Selection.End(xlDown).Select
ActiveCell.Offset(0, 1).Select
Range(Selection, Selection.End(xlUp)).Select
Selection.FillDown

Range("C1").Select
ActiveCell.FormulaR1C1 = "=BDP(CONCATENATE(A1, "" "", B1), ""PRIMARY_EXCHANGE_NAME"")"


i = 1
For Each C In Range("C1:C" & LastRow)
    C.value = "=BDP(CONCATENATE(A" & i & ", "" "", B" & i & "), ""PRIMARY_EXCHANGE_NAME"")"
    i = i + 1
Next



i = 1
For Each C In Range("D1:D" & LastRow)
    C.value = "=BDP(CONCATENATE(A" & i & ", "" "", B" & i & "), ""CUR_MKT_CAP"")"
    i = i + 1
Next


'Save Sheet on desktop
Dim userName As String

'Get user name
userName = Environ$("username")

On Error Resume Next
ActiveWorkbook.SaveAs "C:\Users\" & userName & "\Desktop\" & "Penny Stocks Market Cap UPLOAD.xlsx"
On Error GoTo 0



'set signature
Dim signature As String
signature = getSignature()

Dim stringBody As String

stringBody = "Tony,<br>" & _
            "Can you upload this and see if it works?  Please send back.<br>"

With Application
    .EnableEvents = False
    .ScreenUpdating = False
End With

Set OutApp = CreateObject("Outlook.Application")
Set OutMail = OutApp.CreateItem(0)

On Error Resume Next
With OutMail
    .To = "tnguyen@seia.com"
    .cc = ""
    .Subject = "Penny Stocks Market Cap"
    .HTMLbody = stringBody & signature
    .Attachments.Add ActiveWorkbook.FullName
    .Display  'or use .Send
End With
On Error GoTo 0


With Application
    .EnableEvents = True
    .ScreenUpdating = True
End With

Set OutMail = Nothing
Set OutApp = Nothing



MsgBox "File has been saved onto desktop"



End Sub




