'Version 17
'2/1/17 TLN added sendEmailCombined
'2/16/17 TLN updated work book declaration for FIDO in function sendEmailCombined
'2/27/17 TLN updated html for sendEmailCombined to make it more dynamic (added two optional parameters to function; schwab and fido html)
'3/02/17 TLN clean up sendEmailCombined for workbook schwab and fido
'3/09/17 TLN updated Deron McCoy's logic in sendEmailCombined function
'3/22/17 TLN added getSignature function
'3/27/17 TLN added function checkNonEmailed
'4/11/17 TLN Added slicer function
'4/13/17 TLN added Last Price Function
'4/28/17 TLN added Yahoo pricing 
'6/16/17 TLN added marketHolidays() and IsWeekend
'7/11/17 TLN Test for Git

Function emailDistribution() As Collection
    Dim emailList_ As New Collection

   
    emailList_.Add ("Mark Copeland")
    emailList_.Add ("Terence Dacunha")
    emailList_.Add ("Terence Da Cunha")
    emailList_.Add ("Brian Holmes")
    emailList_.Add ("David Johnson")
    emailList_.Add ("Eric Pritz")
    emailList_.Add ("Fritz Miller")
    emailList_.Add ("Gary Liska")
    emailList_.Add ("Hampton Adams")
    emailList_.Add ("Jennifer Kim")
    emailList_.Add ("John Keenan")
    emailList_.Add ("Kathleen Adams")
    emailList_.Add ("Michael Evans")
    emailList_.Add ("Paul Taghibagi")
    emailList_.Add ("Theodore Saade")
    emailList_.Add ("Tom West")
    emailList_.Add ("Vince DiLeva")
    emailList_.Add ("RMs")
    emailList_.Add ("Robert Curtiss")
    emailList_.Add ("Deron McCoy")


    Set emailDistribution = emailList_
    Set emailList_ = Nothing
End Function

Function colToNumber(colName As String) As Integer
    'function will return 0 if column not found
    Dim strSearch As String
    Dim aCell As Range

    strSearch = colName

    Set aCell = ActiveSheet.Rows(1).Find(What:=strSearch, LookIn:=xlValues, _
    LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, _
    MatchCase:=False, SearchFormat:=False)

    If Not aCell Is Nothing Then
        colToNumber = aCell.Column
    Else
        MsgBox ("Column" & " " & strSearch & " " & "was not found in workbook")
    End If
    
End Function

Function sendEmail(StrBody As String, SubjectLine As String, cc As String)
'1/30/17 TLN updated Deron McCoy e-mail procedure
'1/31/17 TLN added dkellman@seia.com; jchen@seia.com for Deron e-mail option
'3/06/17 TLN added team name update for Hampton Adams
    Dim emailList As Collection
    Dim lastName As String
    Dim teamName As String
    Dim colNumber As Integer
    Dim i As Integer
    Dim FA As String
    Dim rng As Range
    Dim OutApp As Object
    Dim OutMail As Object
    Dim deronOption As Variant
    
    
    Set emailList = emailDistribution()
    'Get column number where header is "Advisor"
    colNumber = colToNumber("Advisor")
     
    'Prompt for shares rounding
    Dim strMsg As String

    strMsg = "Please select an E-Mail for Deron McCoy:" & vbNewLine & vbNewLine
    strMsg = strMsg & "1. dmccoy@seia.com" & vbNewLine
    strMsg = strMsg & "2. pmtrading@seia.com" & vbNewLine
    strMsg = strMsg & "3. RMs" & vbNewLine

 
    For i = 1 To emailList.Count
    
        FA = emailList(i)

        'Determine Team Name for .To in E-mail
        If (InStr(1, emailList(i), " ")) = 0 Then
            lastName = emailList(i)
            teamName = lastName
            
        ElseIf FA = "Deron McCoy" Then
        
        On Error Resume Next
        Cells.Find(What:=FA, After:=ActiveCell, LookIn:=xlFormulas, LookAt:= _
        xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=False) _
        .Activate
        
         If Err <> 0 Then
    
        
            Else
            
              deronOption = InputBox(strMsg, "E-mail Option")
                
                
                'handle cancel/exit button
                If deronOption = vbNullString Then Exit Function
                   

                'check user input
                If Len(deronOption) >= 2 Then
                    MsgBox ("Please Enter Only One Option")
                    deronOption = InputBox(strMsg, "E-mail Option")
                End If
                
                If HasNumber(deronOption) = False Then
                    MsgBox ("Please Enter a Number as an Option")
                    deronOption = InputBox(strMsg, "E-mail Option")
                End If
                
                If CInt(deronOption) >= 4 Then
                    MsgBox ("Please Enter a Number from 1 to 3 as an Option")
                    deronOption = InputBox(strMsg, "E-mail Option")
                End If
                
                
                Select Case deronOption
                  Case "1"
                    teamName = "dmccoy@seia.com"
                  Case "2"
                    teamName = "pmtrading@seia.com"
                  Case "3"
                    teamName = "RMs"
                End Select
            
            End If
        
          
        Else
            lastName = Replace(Trim(Mid(emailList(i), (InStr(1, emailList(i), " ")), (Len(emailList(i)) - (InStr(1, emailList(i), " "))) + 1)), " ", "")
            teamName = lastName + " " + "Team"
            '3/06/17 TLN added team name update for Hampton Adams
            If FA = "Hampton Adams" Then
                teamName = "Adams III Team"
            End If
            '3/06/17 TLN added team name update for Hampton Adams
        End If
        
        
    
        If ActiveSheet.FilterMode Then
            ActiveSheet.ShowAllData
        End If
    
        On Error Resume Next
        Cells.Find(What:=FA, After:=ActiveCell, LookIn:=xlFormulas, LookAt:= _
        xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=False) _
        .Activate
        
         If Err <> 0 Then
        
            Else
              
            ActiveSheet.UsedRange.AutoFilter Field:=colNumber, Criteria1:=FA
                  
            Set rng = Nothing
            On Error Resume Next

            Set rng = Sheets("Expiring").Range("A:G").SpecialCells(xlCellTypeVisible)
        
            On Error GoTo 0
        
            With Application
                .EnableEvents = False
                .ScreenUpdating = False
            End With
        
            Set OutApp = CreateObject("Outlook.Application")
            Set OutMail = OutApp.CreateItem(0)
        
            On Error Resume Next
            With OutMail
                .To = teamName
                .cc = cc
                .Subject = SubjectLine
                .HTMLbody = StrBody & RangetoHTML(rng)
                .Display   'or use .Send
            End With
            On Error GoTo 0
        
            With Application
                .EnableEvents = True
                .ScreenUpdating = True
            End With
        
            Set OutMail = Nothing
            Set OutApp = Nothing
        
        End If
        
        If ActiveSheet.FilterMode Then
            ActiveSheet.ShowAllData
        End If
    
    Next i

End Function

Function HasNumber(strData As Variant) As Boolean
    Dim iCnt As Integer
     
    For iCnt = 1 To Len(strData)
        If IsNumeric(Mid(strData, iCnt, 1)) Then
            HasNumber = True
            Exit Function
        End If
    Next iCnt
     
End Function

Function FindLastColumnLetter() As String
    Dim lastColumn As Integer
    Dim ColumnLetter As String
     
    If WorksheetFunction.CountA(Cells) > 0 Then
         'Search for any entry, by searching backwards by Columns.
        lastColumn = Cells.Find(What:="*", After:=[A1], _
        SearchOrder:=xlByColumns, _
        SearchDirection:=xlPrevious).Column
        
        lastColumn = lastColumn + 1
        
        If lastColumn > 26 Then
            ColumnLetter = Chr(Int((lastColumn - 1) / 26) + 64) & _
            Chr(((lastColumn - 1) Mod 26) + 65)
        Else
            ColumnLetter = Chr(lastColumn + 64)
        End If
        FindLastColumnLetter = ColumnLetter
    End If
    
End Function

Sub TransferValuesOnly()

Dim rng As Range
Dim activesheetName As String


'grab name of active sheet
activesheetName = ActiveSheet.Name

'Grab Some Data and Store it in a "Range" variable
  Set rng = Worksheets(activesheetName).Range("A1:Z100")

'Transfer Values to same spot in another worksheet (Mimics PasteSpecial Values Only)
  Worksheets(activesheetName).Range("A1").Resize(rng.Rows.Count, rng.Columns.Count).Cells.value = rng.Cells.value

End Sub

Sub autofillAndDelete()
'Created by Toan Nguyen 1/12/17
Dim LR As Long
Dim r As Long
Dim rh As Long
Dim iRet As Integer
Dim strPrompt As String
Dim strTitle As String
Dim deleteFlag As Boolean
Dim activesheetName As String
Dim autoFill As Boolean


'grab name of active sheet
activesheetName = ActiveSheet.Name

'autofill columns if blank exists
 LR = Cells(Rows.Count, "A").End(xlUp).Row
 
    For r = 1 To LR
     
        If Worksheets(activesheetName).Cells(r, "B").value = "" Then
            autoFill = True
            Exit For
        Else
            autoFill = False
        End If
     
    Next r
 
 'procedure to autofill
If autoFill Then
    'autofill column B
    For Each Area In Columns("B:B").SpecialCells(xlCellTypeBlanks)
        If Area.Cells.Row <= ActiveSheet.UsedRange.Rows.Count Then
            Area.Cells = Range(Area.Address).Offset(-1, 0).value
        End If
    Next Area
End If



'delete empty rows
    'get total row count for loop
    LR = Cells(Rows.Count, "A").End(xlUp).Row
    
    
    'Prompt
    strPrompt = "There are empty rows in ths record set. Delete them?"
                        
    'Dialog's Title
    strTitle = "Warning"

    Dim ws As Worksheet
    Set ws = ThisWorkbook.ActiveSheet

                           
    'highlight empty rows first
     For r = 1 To LR
     
        If (Worksheets(activesheetName).Cells(r, "E").value = "" And Worksheets(activesheetName).Cells(r, "F").value = "" And Worksheets(activesheetName).Cells(r, "G").value = "") Then
                Rows(r).Interior.ColorIndex = 6
        End If
     
     Next r
                           
                           
                           
     For r = 1 To LR
            'if columns E,F,G are blank, delete the entire row
             If (Worksheets(activesheetName).Cells(r, "E").value = "" And Worksheets(activesheetName).Cells(r, "F").value = "" And Worksheets(activesheetName).Cells(r, "G").value = "") Then
               
               'Display MessageBox
                iRet = MsgBox(strPrompt, vbYesNo, strTitle)
                                    
                ' Check pressed button
                If iRet = vbNo Then
                    deleteFlag = False
                    Exit For
                Else
                    deleteFlag = True
                    Exit For
                End If
               
             End If
     Next r
    
    
    'delete rows if user says delete yes
    For r = 1 To LR
            If deleteFlag Then
                If Cells(r, 1).Interior.ColorIndex = 6 Then
                   Rows(r).EntireRow.Delete
                   r = r - 1
                   LR = Cells(Rows.Count, "A").End(xlUp).Row
                End If
            End If
     Next r

End Sub

Function sendEmailCombined(StrBody As String, SubjectLine As String, cc As String, Optional ByVal fidoMacro As String, Optional ByVal schwabHTML As String, Optional ByVal fidoHTML As String)
'3/06/17 TLN added team name update for Hampton Adams
'3/06/17 TLN moved column number function to schwab code section
'3/09/17 TLN updated Deron McCoy's logic in sendEmailCombined function
    Dim emailList As Collection
    Dim lastName As String
    Dim teamName As String
    Dim colNumber As Integer
    Dim i As Integer
    Dim FA As String
    Dim rng As Range
    Dim rngFido As Range
    Dim OutApp As Object
    Dim OutMail As Object
    Dim deronOption As Variant
    Dim schwabFaFound As Boolean
    Dim fidoFaFound As Boolean
    Dim schwabImage As Variant
    Dim fidoImage As Variant
    Dim deronFound As Boolean
    Dim signature As String
   
    'Schwab book
    Dim wb_SCHWAB As Workbook
    Set wb_SCHWAB = ActiveWorkbook
   
    'FIDO book
    Dim xlFileName As String
    Dim wb_FIDO As Workbook
    Dim fd As Office.FileDialog
    
    'set up Schwab and Fido HTML headers
    Dim schwabHeader As String
    Dim fidoHeader As String
    
    schwabHeader = "<H2><font size=""4.5"" color=""Orange"" face=""Times New Roman""><u>Schwab</u></H2>"
    fidoHeader = "<H2><font size=""4.5"" color=""DarkBlue"" face=""Times New Roman""><u>Fidelity</u></H2>"
    
    'set signature
    signature = getSignature()
    
    'Initialize Deron as False
    deronFound = False
    
    Set fd = Application.FileDialog(msoFileDialogFilePicker)
    
    With fd

        .AllowMultiSelect = False
        .Title = "Please Select the FIDO Options File"
        .Filters.Add "Excel", "*.xls*"
        .Filters.Add "All", "*.*"

        If .Show Then
           xlFileName = .SelectedItems(1)
           
        Else
           'if user pressed CANCEL - exit sub
           MsgBox "No FIDO Options File was chosen; this process will exit"
           Exit Function
        End If

    End With

    'Tries to open workbook with choosen file name
    On Error Resume Next
    Set wb_FIDO = Workbooks.Open(xlFileName)
    On Error GoTo 0
    
    
    'If we can't find workbook with choosen path, exit Sub
    If wb_FIDO Is Nothing Then
        MsgBox "Can't find file"
    End If

    
    'Call FIDO Macro
    Application.Run fidoMacro
    
    '2/16/17 TLN set active work book as wb_FIDO
    Set wb_FIDO = ActiveWorkbook
    

    wb_SCHWAB.Activate

    
    Set emailList = emailDistribution()

    Dim strMsg As String

    strMsg = "Please select an E-Mail for Deron McCoy:" & vbNewLine & vbNewLine
    strMsg = strMsg & "1. dmccoy@seia.com" & vbNewLine
    strMsg = strMsg & "2. pmtrading@seia.com" & vbNewLine
    strMsg = strMsg & "3. RMs" & vbNewLine
  
     
    For i = 1 To emailList.Count
    
        FA = emailList(i)
      
        'Determine Team Name for .To in E-mail
        If (InStr(1, emailList(i), " ")) = 0 Then
            lastName = emailList(i)
            teamName = lastName
            
            
        ElseIf FA = "Deron McCoy" Then
        
        '3/09/17 TLN updated Deron McCoy's logic in sendEmailCombined function
        On Error Resume Next
        wb_SCHWAB.Activate
        'check schwab
        Cells.Find(What:=FA, After:=ActiveCell, LookIn:=xlFormulas, LookAt:= _
        xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=False) _
        .Activate
        
        If Err <> 0 Then
        Else
            deronFound = True
        End If
        
        
        On Error Resume Next
        wb_FIDO.Activate
        'check schwab
        Cells.Find(What:=FA, After:=ActiveCell, LookIn:=xlFormulas, LookAt:= _
        xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=False) _
        .Activate
        
        If Err <> 0 Then
        Else
            deronFound = True
        End If
        '3/09/17 TLN updated Deron McCoy's logic in sendEmailCombined function
        
            If deronFound Then
            
              deronOption = InputBox(strMsg, "E-mail Option")
                
                'handle cancel/exit button
                If deronOption = vbNullString Then Exit Function
                   

                'check user input
                If Len(deronOption) >= 2 Then
                    MsgBox ("Please Enter Only One Option")
                    deronOption = InputBox(strMsg, "E-mail Option")
                End If
                
                If HasNumber(deronOption) = False Then
                    MsgBox ("Please Enter a Number as an Option")
                    deronOption = InputBox(strMsg, "E-mail Option")
                End If
                
                If CInt(deronOption) >= 4 Then
                    MsgBox ("Please Enter a Number from 1 to 3 as an Option")
                    deronOption = InputBox(strMsg, "E-mail Option")
                End If
                
                
                Select Case deronOption
                  Case "1"
                    teamName = "dmccoy@seia.com"
                  Case "2"
                    teamName = "pmtrading@seia.com"
                  Case "3"
                    teamName = "RMs"
                End Select
            
            
            End If
        
          
        Else
            lastName = Replace(Trim(Mid(emailList(i), (InStr(1, emailList(i), " ")), (Len(emailList(i)) - (InStr(1, emailList(i), " "))) + 1)), " ", "")
            teamName = lastName + " " + "Team"
            
            '3/06/17 TLN added team name update for Hampton Adams
            If FA = "Hampton Adams" Then
                teamName = "Adams III Team"
            End If
            '3/06/17 TLN added team name update for Hampton Adams

        End If
        
    
    ''''Schwab
        wb_SCHWAB.Activate
        
        If ActiveSheet.FilterMode Then
            ActiveSheet.ShowAllData
        End If
    
        On Error Resume Next
        Cells.Find(What:=FA, After:=ActiveCell, LookIn:=xlFormulas, LookAt:= _
        xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=False) _
        .Activate
        
         If Err <> 0 Then
        
            Else
              
            schwabFaFound = True
            '3/06/17 TLN moved column number function to schwab code section
            'Get column number where header is "Advisor"
            colNumber = colToNumber("Advisor")
            '3/06/17 TLN moved column number function to schwab code section
            
            ActiveSheet.UsedRange.AutoFilter Field:=colNumber, Criteria1:=FA
            
            Set rng = Nothing
            On Error Resume Next

            Set rng = Sheets("Expiring").Range("A:G").SpecialCells(xlCellTypeVisible)
        
            On Error GoTo 0
            
            schwabImage = RangetoHTML(rng)
        
        End If
        
    
    ''''Fido
        wb_FIDO.Activate
        
        'Find advisor column for  FIDO
        colNumber = colToNumber("Advisor")

        If ActiveSheet.FilterMode Then
            ActiveSheet.ShowAllData
        End If

    
        On Error Resume Next
        Cells.Find(What:=FA, After:=ActiveCell, LookIn:=xlFormulas, LookAt:= _
        xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=False) _
        .Activate

         If Err <> 0 Then

            Else

            fidoFaFound = True

            ActiveSheet.UsedRange.AutoFilter Field:=colNumber, Criteria1:=FA
        
            Set rngFido = Nothing
            On Error Resume Next

            Set rngFido = ActiveSheet.Range("A:G").SpecialCells(xlCellTypeVisible)

            On Error GoTo 0

            fidoImage = RangetoHTML(rngFido)


        End If
        
       
        If (schwabFaFound And fidoFaFound) Then
           With Application
                .EnableEvents = False
                .ScreenUpdating = False
            End With
        
            Set OutApp = CreateObject("Outlook.Application")
            Set OutMail = OutApp.CreateItem(0)
        
            On Error Resume Next
            With OutMail
                .To = teamName
                .cc = cc
                .Subject = SubjectLine
                '2/27/17 TLN updated html for sendEmailCombined to make it more dynamic (added two optional parameters to function; schwab and fido html)
                .HTMLbody = StrBody & schwabHeader & schwabHTML & schwabImage & fidoHeader & fidoHTML & fidoImage & signature
                '2/27/17 TLN updated html for sendEmailCombined to make it more dynamic (added two optional parameters to function; schwab and fido html)
                .Display   'or use .Send
            End With
            On Error GoTo 0
            
            
            With Application
                .EnableEvents = True
                .ScreenUpdating = True
            End With
        
            Set OutMail = Nothing
            Set OutApp = Nothing

        ElseIf (schwabFaFound) Then
           With Application
                .EnableEvents = False
                .ScreenUpdating = False
            End With
        
            Set OutApp = CreateObject("Outlook.Application")
            Set OutMail = OutApp.CreateItem(0)
        
            On Error Resume Next
            With OutMail
                .To = teamName
                .cc = cc
                .Subject = SubjectLine
                '2/27/17 TLN updated html for sendEmailCombined to make it more dynamic (added two optional parameters to function; schwab and fido html)
                .HTMLbody = StrBody & schwabHeader & schwabHTML & schwabImage & signature
                '2/27/17 TLN updated html for sendEmailCombined to make it more dynamic (added two optional parameters to function; schwab and fido html)
                .Display   'or use .Send
            End With
            On Error GoTo 0
            
            
            With Application
                .EnableEvents = True
                .ScreenUpdating = True
            End With
        
            Set OutMail = Nothing
            Set OutApp = Nothing
            
         ElseIf (fidoFaFound) Then
           With Application
                .EnableEvents = False
                .ScreenUpdating = False
            End With
        
            Set OutApp = CreateObject("Outlook.Application")
            Set OutMail = OutApp.CreateItem(0)
        
            On Error Resume Next
            With OutMail
                .To = teamName
                .cc = cc
                .Subject = SubjectLine
                '2/27/17 TLN updated html for sendEmailCombined to make it more dynamic (added two optional parameters to function; schwab and fido html)
                .HTMLbody = StrBody & fidoHeader & fidoHTML & fidoImage & signature
                '2/27/17 TLN updated html for sendEmailCombined to make it more dynamic (added two optional parameters to function; schwab and fido html)
                .Display   'or use .Send
            End With
            On Error GoTo 0
            
            
            With Application
                .EnableEvents = True
                .ScreenUpdating = True
            End With
        
            Set OutMail = Nothing
            Set OutApp = Nothing

        End If
        
        
    'reset filter for both workbooks
    wb_FIDO.Activate
    If ActiveSheet.FilterMode Then
        ActiveSheet.ShowAllData
    End If
 
    
    wb_SCHWAB.Activate
     If ActiveSheet.FilterMode Then
        ActiveSheet.ShowAllData
    End If
  
    
    'reset boolean
    schwabFaFound = False
    fidoFaFound = False
    
    Next i

    '3/02/17 TLN clean up sendEmailCombined for workbook schwab and fido
    Set wb_SCHWAB = Nothing
    Set wb_FIDO = Nothing
    '3/02/17 TLN clean up sendEmailCombined for workbook schwab and fido
    
End Function

Function getSignature() As String
Dim userName As String

'Get user name
userName = Environ$("username")


Select Case userName

   Case "rreyes"
            getSignature = "<p><font color=Black>" & "<span style='font-size:11pt;font-family:Calibri;'>" & _
                "<b>Ronald Reyes, CMT</b><br>" & _
                "Senior Trader<br>" & _
                "SEIA, LLC<br>" & _
                "610 Newport Center Drive, Suite 300<br>" & _
                "Newport Beach, CA 92660<br>" & _
                "Phone: 949-705-5197<br>" & _
                "Fax: 949-705-5199<br><br>" & _
                "<span style='font-size:10pt;font-family:Calibri;'>" & _
                "<span style='color:red;'><b>Time Sensitive Information:</b></span><br>" & _
                "General information should cc: <a href= 'mailto:operations@seia.com'><span style='color:blue;text-decoration: underline;'>operations@seia.com</span></a>; Trading directions should cc: <a href= 'mailto:trading@seia.com'><span style='color:blue;text-decoration: underline;'>trading@seia.com</span></a><br><br>" & _
                "Registered Representative/Securities Offered through Signator Investors, Inc., Member FINRA, SIPC, 2121 Ave of the Stars, Suite 1600, Los Angeles, CA 90067 (310)712-2323. SEIA, LLC and its investment advisory services are offered independent of Signator Investors, Inc. and any subsidiaries or affiliates." & _
                "</font>" & "</span>" & _
                "</font>" & "</span></p>"
   
   Case "tnguyen"
            getSignature = "<p><font color=Black>" & "<span style='font-size:10pt;font-family:Tahoma;'>" & _
                "Sincerely,<br>" & _
                "Tony Nguyen, CMFC®<br>" & _
                "Fixed Income Trader<br>" & _
                "<span style='font-size:10pt;font-family:Calibri;'><i>310-712-2351 Direct</i></span><br><br>" & _
                "<span style='font-size:10pt;font-family:Calibri;'>" & _
                "<span style='color:red;'><b>Time Sensitive Information:</b></span>" & _
                "<br>" & _
                "General information should cc: <a href= 'mailto:operations@seia.com'><span style='color:blue;text-decoration: underline;'>operations@seia.com</span></a>; Trading directions should cc: <a href= 'mailto:trading@seia.com'><span style='color:blue;text-decoration: underline;'>trading@seia.com</span></a><br><br>" & _
                "<span style='font-size:10pt;font-family:Calibri;color:gray'>" & _
                "<b>Signature Estate & Investment Advisors, LLC</b><br>2121 Avenue of the Stars, Suite 1600<br>Los Angeles, CA 90067<br>(310) 712-2323 | Phone<br><a href= 'mailto:tnguyen@seia.com'><span style='color:blue;text-decoration: underline;'><i>tnguyen@seia.com</i></span></a> | Email<br><br><br>" & _
                "<span style='font-size:11pt;font-family:Calibri;color:black'>Registered Representative/Securities offered through Signator Investors, Inc. Member FINRA, SIPC,<br><br>2121 Avenue of the Stars, Suite 1600, Los Angeles, CA 90067</span>" & _
                "</font>" & "</span>" & _
                "</font>" & "</span></p>"
                

   Case "vhreyes"
            getSignature = "<p><font color=Black>" & "<span style='font-size:10pt;font-family:Tahoma;'>" & _
                "Sincerely,<br>" & _
                "Vince Reyes, CMFC®<br>" & _
                "Director of Trading Operations<br>" & _
                "310-712-2352 Direct<br>" & _
                "<span style='font-size:10pt;font-family:Tahoma;'>" & _
                "<br>" & _
                "If there are ever any questions, please do not hesitate to contact my office.  Also, please remember time sensitive information should be sent to the appropriate email address below.</span><br><br>" & _
                "Time Sensitive Information:<br>General information should cc: <span style='color:blue;text-decoration: underline;'>operations@seia.com</span>; Trading directions should cc: <span style='color:blue;text-decoration: underline;'>trading@seia.com</span><br>Signature Estate & Investment Advisors, LLC<br>2121 Avenue of the Stars, Suite 1600<br>Los Angeles, CA 90067<br>(310) 712-2323 | Phone<br><span style='color:blue;text-decoration: underline;'>vreyes@seia.com</span> | Email<br><br>" & _
                "Registered Representative/Securities offered through Signator Investors, Inc. Member FINRA, SIPC,<br>2121 Avenue of the Stars, Suite 1600, Los Angeles, CA 90067 (310) 712-2323.<br>SEIA,LLC and its investment advisory services are offered independent of Signator Investors, Inc. and any subsidiaries or affiliates." & _
                "</font>" & "</span>" & _
                "</font>" & "</span></p>"
                
   Case "toan_nguyen"
                 getSignature = "<p><font color=Black>" & "<span style='font-size:10pt;font-family:Tahoma;'>" & _
                "Sincerely,<br>" & _
                "Toan Nguyen, CMFC®<br>" & _
                "Developer<br>" & _
                "<span style='font-size:10pt;font-family:Calibri;'><i>310-712-2351 Direct</i></span><br><br>" & _
                "<span style='font-size:10pt;font-family:Calibri;'>" & _
                "<span style='color:red;'><b>Time Sensitive Information:</b></span>" & _
                "<br>" & _
                "General information should cc: <a href= 'mailto:operations@seia.com'><span style='color:blue;text-decoration: underline;'>operations@seia.com</span></a>; Trading directions should cc: <a href= 'mailto:trading@seia.com'><span style='color:blue;text-decoration: underline;'>trading@seia.com</span></a><br><br>" & _
                "</font>" & "</span>" & _
                "</font>" & "</span></p>"


End Select


End Function

Sub CleanSelection()
    Dim C As Range, rng As Range
    Set rng = Intersect(Selection, Selection.Parent.UsedRange)
    If rng Is Nothing Then
        MsgBox "No cells with values!"
        Exit Sub
    End If
    For Each C In rng
        If Not IsError(C) Then
            C.value = MEGACLEAN(C)
        End If
    Next C
End Sub

Function MEGACLEAN(varVal As Variant)
Dim NewVal As Variant
If IsMissing(varVal) Then Exit Function
NewVal = Trim(varVal) 'remove spaces
NewVal = Application.WorksheetFunction.Clean(NewVal) 'remove most unwanted characters
NewVal = Application.WorksheetFunction.Substitute(NewVal, Chr(127), "") 'remove ASCII#127
NewVal = Application.WorksheetFunction.Substitute(NewVal, Chr(160), "") 'remove ASCII#160

MEGACLEAN = NewVal
End Function
Sub ConvertToNumbers()
'used for OptionsExpiration macro
'used for SchwabGTCByAdvisor

    Dim rng As Range

'get constants in selected range
    On Error Resume Next
    Set rng = Selection _
        .SpecialCells(xlCellTypeConstants, 23)
    On Error GoTo errHandler

    If Not rng Is Nothing Then
        'copy blank cell outside used range
        Cells.SpecialCells(xlCellTypeLastCell) _
            .Offset(0, 1).Copy
  
        'add to selected cells
        rng.PasteSpecial Paste:=xlPasteValues, _
            Operation:=xlPasteSpecialOperationAdd
    Else
        MsgBox "Could not find Constants in selection"
    End If

exitHandler:
    Application.CutCopyMode = False
    Set rng = Nothing
    Exit Sub
errHandler:
    MsgBox "Could not change text to numbers"
    Resume exitHandler
    
    End Sub

Function RangetoHTML(rng As Range)
'TLN 2/23/17 removed white space

' Working in Office 2000-2013
    Dim fso As Object
    Dim ts As Object
    Dim TempFile As String
    Dim TempWB As Workbook

    TempFile = Environ$("temp") & "\" & Format(Now, "dd-mm-yy h-mm-ss") & ".htm"

'Copy the range and create a new workbook to past the data in

    
    ActiveSheet.UsedRange.Copy
    'Rng.Copy
    'ActiveSheet.UsedRange.Select
    Set TempWB = Workbooks.Add(1)
    With TempWB.Sheets(1)
        .Cells(1).PasteSpecial Paste:=8
        .Cells(1).PasteSpecial xlPasteValues, , False, False
        .Cells(1).PasteSpecial xlPasteFormats, , False, False
        .Cells(1).Select
        Application.CutCopyMode = False
        On Error Resume Next
        .DrawingObjects.Visible = True
        .DrawingObjects.Delete
        On Error GoTo 0
    End With
    
'AutoFit All Columns on Worksheet
    Columns("A:Z").EntireColumn.AutoFit
   
    
    
'Publish the sheet to a htm file
    With TempWB.PublishObjects.Add( _
         SourceType:=xlSourceRange, _
         fileName:=TempFile, _
         Sheet:=TempWB.Sheets(1).Name, _
         Source:=TempWB.Sheets(1).UsedRange.Address, _
         HtmlType:=xlHtmlStatic)
        .Publish (True)
    End With

'Read all data from the htm file into RangetoHTML
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set ts = fso.GetFile(TempFile).OpenAsTextStream(1, -2)
    RangetoHTML = ts.readall
    ts.Close
    RangetoHTML = Replace(RangetoHTML, "align=center x:publishsource=", _
                          "align=left x:publishsource=")

''''Begin''''''''''TLN 2/23/17 removed white space'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Remove space above first line of test
RangetoHTML = Replace(RangetoHTML, "<!--[if !excel]>&nbsp;&nbsp;<![endif]-->", "")
''''End''''''''''TLN 2/23/17 removed white space'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

'Close TempWB
    TempWB.Close SaveChanges:=False

'Delete the htm file we used in this function
    Kill TempFile

    Set ts = Nothing
    Set fso = Nothing
    Set TempWB = Nothing
End Function


Function checkNonEmailed(reportName As String, custodian As String)
'03/28/2017 TLN Initial version
'This function will send out and e-mail for anything that isn't in the advisors list

    'create variable for current wb
    Dim active_w As Worksheet
    Set active_w = ActiveSheet
    
    
    'keep track of whats no e-mailed
    Dim wb_temp As Workbook
    Set wb_temp = Workbooks.Add
    
    
    Dim temp_sheet As Worksheet
    Set temp_sheet = ActiveSheet
    
    Dim rng As Range
    Dim image As Variant
   
    
    active_w.Activate
    'clear any thing on clipboard to maximize available memory
    Application.CutCopyMode = False
    
    'copy the range from source book
    active_w.UsedRange.Copy
    'wbThis.Range("A12:M62").Copy
    
    
    'paste the data on the target book
    temp_sheet.Range("A1").PasteSpecial
    
    
   'clear any thing on clipboard to maximize available memory
    Application.CutCopyMode = False

    temp_sheet.Activate
    
    'find advisor and loop
    Dim emailList As Collection
    Set emailList = emailDistribution()
    
    For i = 1 To emailList.Count

        Dim FA As String
        Dim Firstrow As Long
        Dim LastRow As Long
        Dim Lrow As Long
        Dim CalcMode As Long
        Dim ViewMode As Long
        Dim colNumber As Integer
        
        With Application
            CalcMode = .Calculation
            .Calculation = xlCalculationManual
            .ScreenUpdating = False
        End With
        
        
        FA = emailList(i)
        
        colNumber = colToNumber("Advisor")
        
        'We use the ActiveSheet but you can replace this with
        'Sheets("MySheet")if you want
        With ActiveSheet
    
            'We select the sheet so we can change the window view
            .Select
    
            'If you are in Page Break Preview Or Page Layout view go
            'back to normal view, we do this for speed
            ViewMode = ActiveWindow.View
            ActiveWindow.View = xlNormalView
    
            'Turn off Page Breaks, we do this for speed
            .DisplayPageBreaks = False
    
            'Set the first and last row to loop through
            Firstrow = .UsedRange.Cells(1).Row
            LastRow = .UsedRange.Rows(.UsedRange.Rows.Count).Row
    
            'We loop from Lastrow to Firstrow (bottom to top)
            For Lrow = LastRow To Firstrow Step -1
    
                'We check the values in the A column4 in this example
                With .Cells(Lrow, colNumber)
    
                    If Not IsError(.value) Then
    
                        If .value = FA Then .EntireRow.Delete
                        'This will delete each row with the Value "ron"
    
                    End If
    
                End With
    
            Next Lrow
    
        End With
    
            ActiveWindow.View = ViewMode
            With Application
                .ScreenUpdating = True
                .Calculation = CalcMode
        End With


    Next i

    
    'check if there is any data below header
    If IsEmpty(Range("A2").value) = False Then
    
    'send email
    

        Set rng = Nothing
        
        Set rng = temp_sheet.UsedRange.SpecialCells(xlCellTypeVisible)
        image = RangetoHTML(rng)
            
         With Application
                .EnableEvents = False
                .ScreenUpdating = False
            End With
        
            Set OutApp = CreateObject("Outlook.Application")
            Set OutMail = OutApp.CreateItem(0)
        
            On Error Resume Next
            With OutMail
                .To = "rreyes@seia.com;tnguyen@seia.com"
                .cc = "toan.nguyen@seia.com"
                .Subject = "These are the email's that weren't sent out for report " & custodian & " " & reportName
                .HTMLbody = image
                .FlagRequest = "Follow up"
                .FlagIcon = 6
                .Categories = ""
                .Display  'or use .Send
            End With
            On Error GoTo 0
            
            
            With Application
                .EnableEvents = True
                .ScreenUpdating = True
            End With
        
            Set OutMail = Nothing
            Set OutApp = Nothing
    
      
    End If
    
    
    wb_temp.Close False
    Set temp_sheet = Nothing
    Set wb_temp = Nothing
  
    
 End Function

Function Last()
' TLN Grab last price using Yahoo
    Dim w As Worksheet
    Set w = ActiveSheet

    Dim symbolColumn As Integer
    Dim lastColumn As Integer
    Dim symbolColLetter As String
    
    
    symbolColumn = colToNumber("Symbol")
    lastColumn = colToNumber("Last")
    
    
    Dim vArr
    vArr = Split(Cells(1, symbolColumn).Address(True, False), "$")
    symbolColLetter = vArr(0)

 '===============================Grab Yahoo prices=============================================

    Dim symbols As String
    
    Dim LastPrice As Integer
    LastPrice = w.Range(symbolColLetter & "10000").End(xlUp).Row
    

    If LastPrice = 1 Then MsgBox "No Symbols": Exit Function 'if no symbols, it will exit sub
    
'To test the value of next row
    Dim rcel As Range
    Set rCell = Range("A3")
    
    If IsEmpty(rCell) Then

        symbols2 = Range(symbolColLetter & "2").value
        symbols = Replace(symbols2, "+", "-P")
                        
    Else

'replace "+" with "-P", and join all cells together with separated by "+"
    symbols = Replace(Replace(Join(Application.Transpose(Range("F2", Cells(Rows.Count, "F").End(xlUp))), Chr(1)), "+", "-P"), Chr(1), "+")
  
    End If
    
 
'Create URL
    Dim URL As String: URL = "http://finance.yahoo.com/d/quotes.csv?s=" & symbols & "&f=sl1"
    
'======================================Download data======================================

    Dim http As New WinHttpRequest
    http.Open "GET", URL, False
    http.Send
       
    Dim Resp As String: Resp = http.ResponseText
    Dim lines As Variant: lines = Split(Resp, vbLf) 'go line by line, splitting information

    Dim sline As String
    Dim Values As Variant
    
    For i = 0 To UBound(lines)
        sline = lines(i)
        If InStr(sline, ",") > 0 Then
        
            Values = Split(sline, ",")
            w.Cells(i + 2, lastColumn).value = Replace(Values(1), Chr(34), "")
            
        End If
            
    Next i
    
'===============================END Grab Yahoo prices=============================================



End Function

Function Slicer()


Dim w As Worksheet
    Dim rng As Range
    
    Set w = ActiveSheet
    Set rng = ActiveSheet.UsedRange
    
    w.UsedRange.Select
    
    w.ListObjects.Add(xlSrcRange, rng, , xlYes).Name = _
        "Table1"
        
    Range("Table1[#All]").Select
    ActiveWorkbook.SlicerCaches.Add2(ActiveSheet.ListObjects("Table1"), "Advisor"). _
        Slicers.Add ActiveSheet, , "Advisor", "Advisor", 176.25, 639.75, 144, 198.75
    ActiveSheet.Shapes.Range(Array("Advisor")).Select
    
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    Dim lColumn As Long

    lColumn = ActiveSheet.UsedRange.Columns.Count

    lColumn = lColumn + 2
    
    Dim vArr
    vArr = Split(Cells(1, lColumn).Address(True, False), "$")
    Col_Letter = vArr(0)
        
        

    With ActiveSheet.Shapes("Advisor")
        .Top = Range(Col_Letter & lColumn).Top
        .Left = Range(Col_Letter & lColumn).Left
    End With
    
    ActiveSheet.Shapes("Advisor").IncrementTop -163.5
  ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''


End Function



Function YahooPrices(symbolColLetter As String, priceColNumber As Integer)



'===============================Grab Yahoo prices=============================================
    Dim w As Worksheet
    Set w = ActiveSheet

    Dim symbols As String
    
    Dim Last As Integer
    Last = w.Range(symbolColLetter & "1000000").End(xlUp).Row
    
    Debug.Print Last

    If Last = 1 Then MsgBox "No Symbols": Exit Function 'if no symbols, it will exit sub
    
'To test the value of next row
    Dim rcel As Range
    Set rCell = Range("A3")
    
    If IsEmpty(rCell) Then

        symbols2 = Range(symbolColLetter & "2").value
        symbols = Replace(symbols2, "+", "-P")
                        
    Else

'replace "+" with "-P", and join all cells together with separated by "+"
    symbols = Replace(Replace(Join(Application.Transpose(Range(symbolColLetter & "2", Cells(Rows.Count, symbolColLetter).End(xlUp))), Chr(1)), "+", "-P"), Chr(1), "+")
  
    End If
    
    Debug.Print symbols
    
'Create URL
    Dim URL As String: URL = "http://download.finance.yahoo.com/d/quotes.csv?s=" & symbols & "&f=sl1"
    
Debug.Print URL

'======================================Download data======================================

    Dim http As New WinHttpRequest
    http.Open "GET", URL, False
    http.Send
       
    Dim Resp As String: Resp = http.ResponseText
    Dim lines As Variant: lines = Split(Resp, vbLf) 'go line by line, splitting information

    Dim sline As String
    Dim Values As Variant
    
    For i = 0 To UBound(lines)
        sline = lines(i)
        If InStr(sline, ",") > 0 Then
        
            Values = Split(sline, ",")
            w.Cells(i + 2, priceColNumber).value = Replace(Values(1), Chr(34), "")
            
        End If
            
    Next i
    
'===============================END Grab Yahoo prices=============================================

End Function

Function marketHolidays() As Collection
    Dim holidayList_ As New Collection

   
    holidayList_.Add ("01/02/2017")
    holidayList_.Add ("01/16/2017")
    holidayList_.Add ("02/20/2017")
    holidayList_.Add ("04/14/2017")
    holidayList_.Add ("05/29/2017")
    holidayList_.Add ("07/04/2017")
    holidayList_.Add ("09/04/2017")
    holidayList_.Add ("11/23/2017")
    holidayList_.Add ("12/25/2017")
    
    
    holidayList_.Add ("01/02/2018")
    holidayList_.Add ("01/15/2018")
    holidayList_.Add ("02/19/2018")
    holidayList_.Add ("03/30/2018")
    holidayList_.Add ("05/28/2018")
    holidayList_.Add ("07/04/2018")
    holidayList_.Add ("09/03/2018")
    holidayList_.Add ("11/22/2018")
    holidayList_.Add ("12/25/2018")
    
    
    holidayList_.Add ("01/02/2019")
    holidayList_.Add ("01/21/2019")
    holidayList_.Add ("02/18/2019")
    holidayList_.Add ("04/19/2019")
    holidayList_.Add ("05/27/2019")
    holidayList_.Add ("07/04/2019")
    holidayList_.Add ("09/02/2019")
    holidayList_.Add ("11/28/2019")
    holidayList_.Add ("12/25/2019")
    
    holidayList_.Add ("01/02/2020")
    holidayList_.Add ("01/20/2020")
    holidayList_.Add ("02/17/2020")
    holidayList_.Add ("04/10/2020")
    holidayList_.Add ("05/25/2020")
    holidayList_.Add ("07/03/2020")
    holidayList_.Add ("09/07/2020")
    holidayList_.Add ("11/26/2020")
    holidayList_.Add ("12/25/2020")


    Set marketHolidays = holidayList_
    Set holidayList_ = Nothing
End Function

Function IsWeekend(InputDate As Date) As Boolean
    Select Case Weekday(InputDate)
        Case vbSaturday, vbSunday
            IsWeekend = True
        Case Else
            IsWeekend = False
    End Select
End Function


